<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>„Ç≥„Çπ„É¢„Åï„Çì„ÅΩ DX</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
body {
  width: 100%; height: 100vh; overflow: hidden;
  background: #0a0a1a;
  font-family: "M PLUS Rounded 1c", sans-serif;
  touch-action: none;
  color: #fff;
  display: flex;
  flex-direction: column;
}

#gameArea {
  position: relative;
  flex: 1;
  width: 100%;
  background: #182848;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}

#gameSVG {
  width: 100%; height: 100%;
  max-width: 800px;
  background: radial-gradient(circle at center, #5c7cfa 0%, #182848 100%);
}
@media (min-width: 801px) {
  #gameSVG {
    height: auto; aspect-ratio: 4/3;
    border: 8px solid #fff; border-radius: 20px;
  }
}

.ui-box {
  position: absolute; background: rgba(0,0,0,0.6); color: #fff;
  padding: 6px 14px; border-radius: 15px; border: 2px solid #fff;
  font-size: 14px; pointer-events: none; z-index: 10;
}
#stats { top: 15px; left: 15px; display: flex; gap: 10px; }
#swarmCounter { bottom: 15px; right: 15px; font-size: 16px; background: rgba(255, 71, 87, 0.9); }
#stageIndicator {
  top: 15px; right: 15px; font-size: 13px; background: rgba(92, 124, 250, 0.8);
  display: none;
}

/* ===== „Ç™„Éº„Éê„Éº„É¨„Ç§ ===== */
#overlay {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.92); z-index: 999;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  backdrop-filter: blur(6px);
  transition: opacity 0.5s;
}
#overlay.hidden { opacity: 0; pointer-events: none; }

/* „Éó„É≠„É≠„Éº„Ç∞Áî® */
#prologueContainer {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%; height: 100%;
  position: relative;
}
#prologueSVG {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
}
.prologue-line {
  font-size: 18px; line-height: 2.4; color: #fff;
  opacity: 0; transform: translateY(12px);
  transition: opacity 0.8s ease, transform 0.8s ease;
  text-align: center;
  text-shadow: 0 2px 8px rgba(0,0,0,0.6);
  position: relative; z-index: 2;
}
.prologue-line.visible {
  opacity: 1; transform: translateY(0);
}
.prologue-line.speaker {
  color: #ffeaa7; font-size: 16px;
}
#prologueSkip {
  position: absolute; bottom: 40px; z-index: 3;
  background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.4);
  color: #fff; padding: 10px 30px; border-radius: 30px;
  font-size: 15px; cursor: pointer; opacity: 0;
  transition: opacity 0.5s;
  font-family: "M PLUS Rounded 1c", sans-serif;
}
#prologueSkip.visible { opacity: 1; }
#prologueSkip:active { background: rgba(255,255,255,0.3); }

/* „Çπ„ÉÜ„Éº„Ç∏ÈñìÊºîÂá∫ */
#stageOverlay {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85); z-index: 998;
  display: none; flex-direction: column;
  justify-content: center; align-items: center;
  backdrop-filter: blur(4px);
}
#stageTitle {
  font-size: 24px; color: #74b9ff; margin-bottom: 12px;
  opacity: 0; transition: opacity 0.6s;
  text-shadow: 0 0 20px rgba(116, 185, 255, 0.5);
}
#stageMessage {
  font-size: 16px; color: #dfe6e9; text-align: center; line-height: 1.8;
  opacity: 0; transition: opacity 0.6s;
  max-width: 80%;
}
#stageTitle.visible, #stageMessage.visible { opacity: 1; }

/* „Ç®„É≥„Éá„Ç£„É≥„Ç∞ */
#endingContainer {
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  width: 100%; height: 100%; position: relative;
}
#endingSVG {
  width: 300px; height: 200px; margin-bottom: 20px;
  opacity: 0; transition: opacity 1s;
}
#endingSVG.visible { opacity: 1; }
.ending-line {
  font-size: 17px; line-height: 2.2; color: #fff;
  opacity: 0; transition: opacity 0.8s ease;
  text-align: center;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
.ending-line.visible { opacity: 1; }
.ending-title {
  font-size: 28px; color: #f1c40f; margin-bottom: 16px;
  text-shadow: 0 0 20px rgba(241, 196, 15, 0.4);
}

/* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
#titleContainer {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
#titleLogo {
  font-size: 36px; color: #f1c40f;
  text-shadow: 0 4px 0 #e67e22, 0 0 30px rgba(241, 196, 15, 0.3);
  margin-bottom: 8px;
}
#titleSub {
  font-size: 14px; color: #a4b0be; margin-bottom: 30px;
}
#titleDesc {
  font-size: 14px; line-height: 1.8; text-align: center;
  color: #dfe6e9; margin-bottom: 30px;
}
.btn-start {
  background: #2ed573; border: 4px solid #fff; color: white;
  padding: 15px 40px; font-size: 20px; border-radius: 50px;
  font-weight: bold; cursor: pointer;
  box-shadow: 0 6px 0 #1e8449;
  transition: transform 0.1s;
  font-family: "M PLUS Rounded 1c", sans-serif;
}
.btn-start:active { transform: translateY(4px); box-shadow: 0 2px 0 #1e8449; }

/* „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº */
#gameoverContainer {
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
}
#gameoverTitle {
  font-size: 26px; color: #a4b0be; margin-bottom: 16px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
#gameoverMsg {
  font-size: 15px; color: #dfe6e9; text-align: center;
  line-height: 1.8; margin-bottom: 30px;
}

/* ===== „Ç≤„Éº„É†„Éú„Éº„Ç§È¢®„Ç≥„É≥„Éà„É≠„Éº„É©„Éº ===== */
#controls {
  height: 200px;
  background: #dcdde1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 30px;
  box-shadow: inset 0 10px 20px rgba(0,0,0,0.1);
  z-index: 100;
  border-bottom-right-radius: 20px;
  border-bottom-left-radius: 20px;
}

.dpad-container {
  position: relative; width: 140px; height: 140px;
}
.dpad-cross-h {
  position: absolute; top: 50px; left: 10px; width: 120px; height: 40px;
  background: #2d3436; border-radius: 4px; box-shadow: 0 4px 0 #000;
}
.dpad-cross-v {
  position: absolute; top: 10px; left: 50px; width: 40px; height: 120px;
  background: #2d3436; border-radius: 4px; box-shadow: 0 4px 0 #000;
}
.dpad-center-circle {
  position: absolute; top: 55px; left: 55px; width: 30px; height: 30px;
  background: radial-gradient(circle, #2d3436 20%, #1a1a1a 80%);
  border-radius: 50%; opacity: 0.8;
}
.dpad-touch {
  position: absolute; width: 50px; height: 50px; z-index: 10;
}
.touch-up { top: 0; left: 45px; height: 60px; }
.touch-down { bottom: 0; left: 45px; height: 60px; }
.touch-left { top: 45px; left: 0; width: 60px; }
.touch-right { top: 45px; right: 0; width: 60px; }

.action-area {
  position: relative; width: 160px; height: 140px;
  display: flex; align-items: flex-end; justify-content: flex-end;
}
.btns-bg {
  position: absolute; bottom: 20px; right: 0;
  width: 140px; height: 70px;
  background: rgba(0,0,0,0.05); border-radius: 35px;
  transform: rotate(-15deg);
}
.ab-btn {
  width: 60px; height: 60px; border-radius: 50%;
  background: #e74c3c;
  box-shadow: 0 4px 0 #c0392b, 2px 5px 10px rgba(0,0,0,0.2);
  display: flex; justify-content: center; align-items: center;
  font-weight: bold; font-size: 20px; color: rgba(0,0,0,0.2);
  position: absolute;
  transition: transform 0.1s, box-shadow 0.1s;
}
.ab-btn:active {
  transform: translateY(4px); box-shadow: 0 0 0 #c0392b, inset 0 2px 5px rgba(0,0,0,0.3);
}
.btn-a { bottom: 30px; right: 10px; }
.btn-b { bottom: 10px; right: 80px; }
.btn-label {
  position: absolute; font-size: 14px; color: #636e72; font-weight: bold;
}

@media (min-width: 801px) {
  #controls { display: none; }
}
</style>
</head>
<body>

<div id="gameArea">
  <svg id="gameSVG" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
    <g id="bgLayer"></g>
    <g id="gameWorld"></g>
    <g id="uiLayer"></g>
  </svg>

  <div id="stats" class="ui-box" style="display:none;">
    <div>‚ù§Ô∏è <span id="hpText">100</span></div>
    <div>‚≠ê <span id="rankText">1</span></div>
  </div>
  <div id="swarmCounter" class="ui-box" style="display:none;">
    ‚òÖ <span id="swarmText">0</span>
  </div>
  <div id="stageIndicator" class="ui-box">
    <span id="stageLabel"></span>
  </div>

  <!-- „Çπ„ÉÜ„Éº„Ç∏ÈñìÊºîÂá∫ -->
  <div id="stageOverlay">
    <div id="stageTitle"></div>
    <div id="stageMessage"></div>
  </div>

  <!-- „É°„Ç§„É≥„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div id="overlay">
    <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
    <div id="titleContainer">
      <div id="titleLogo">„Ç≥„Çπ„É¢„Åï„Çì„ÅΩ DX</div>
      <div id="titleSub">„Äú „Ç≥„Çπ„É¢„ÅÆ„ÅÜ„Åø„ÅÆ „Åä„Åï„Çì„ÅΩ „Äú</div>
      <div id="titleDesc">
        „Ç≥„Çπ„É¢„Åü„Å°„Çí „ÅÇ„Å§„ÇÅ„Å¶<br>
        „Éò„É≥„ÉÜ„Ç≥„ÅÆ „Åî„Åç„Åí„Çì„Çí „Å™„Åä„Åù„ÅÜÔºÅ
      </div>
      <div class="btn-start" id="btnStart">„ÅØ„Åò„ÇÅ„Çã</div>
    </div>

    <!-- „Éó„É≠„É≠„Éº„Ç∞ -->
    <div id="prologueContainer">
      <svg id="prologueSVG" viewBox="0 0 400 300"></svg>
      <div class="prologue-line" data-delay="500">„Åì„Åì„ÅØ „Ç≥„Çπ„É¢„ÅÆ„ÅÜ„Åø„ÄÇ</div>
      <div class="prologue-line" data-delay="2200">„Å°„ÅÑ„Åï„Å™Êòü„Åü„Å°„Åå „ÇÜ„Å£„Åü„Çä „Åü„Å†„Çà„ÅÜ</div>
      <div class="prologue-line" data-delay="3900">„Åó„Åö„Åã„Åß „ÅÇ„Åü„Åü„Åã„ÅÑ „Å∞„Åó„Çá„ÄÇ</div>
      <div class="prologue-line" data-delay="6200">‚Ä¶„ÅÇ„ÇåÔºü</div>
      <div class="prologue-line" data-delay="7800">„Ç≥„Çπ„É¢„Åü„Å°„Åå „Éê„É©„Éê„É©„Å´ „Å´„Åí„Å¶„ÇãÔºÅ</div>
      <div class="prologue-line" data-delay="9800">„Å™„Å´„Åã „Åä„Åä„Åç„Å™„ÇÇ„ÅÆ„Åå „ÅÇ„Å∞„Çå„Å¶„Çã„Åø„Åü„ÅÑ„ÄÇ</div>
      <div class="prologue-line speaker" data-delay="12000">„Äå„Çà„Åó„ÄÅ„Åø„Çì„Å™„Çí „ÅÇ„Å§„ÇÅ„Å´„ÅÑ„Åì„ÅÜÔºÅ„Äç</div>
      <div id="prologueSkip">‚Äï „Çø„ÉÉ„Éó„Åó„Å¶ „ÅØ„Åò„ÇÅ„Çã ‚Äï</div>
    </div>

    <!-- „Ç®„É≥„Éá„Ç£„É≥„Ç∞ -->
    <div id="endingContainer">
      <svg id="endingSVG" viewBox="0 0 300 200"></svg>
      <div class="ending-line ending-title" data-delay="1000">‚òÖ „Ç≥„Çπ„É¢„ÅÆ„ÅÜ„Åø„Å´ „Å∏„ÅÑ„Çè„Åå „ÇÇ„Å©„Å£„Åü ‚òÖ</div>
      <div class="ending-line" data-delay="3000">„Éë„Éë„Éò„É≥„ÉÜ„Ç≥„ÅØ „Åª„Çì„Å®„ÅÜ„ÅØ</div>
      <div class="ending-line" data-delay="4500">„Åø„Çì„Å™„Å® „ÅÇ„Åù„Å≥„Åü„Åã„Å£„Åü„Å†„Åë „Å†„Å£„Åü„ÄÇ</div>
      <div class="ending-line" data-delay="6500">„Ç≥„Çπ„É¢„Åü„Å°„ÅÆ „ÅÇ„Åü„Åü„Åã„Åï„Åå</div>
      <div class="ending-line" data-delay="8000">„Å§„Åü„Çè„Å£„Åü„Çì„Å†„Å≠„ÄÇ</div>
      <div class="ending-line" data-delay="10500" style="color:#ffeaa7; margin-top:16px;">„Åø„Çì„Å™„Åß „Åª„Åó„ÅÆ„ÅÜ„Åà„ÅÆ „Éî„Ç∂„Éë„Éº„ÉÜ„Ç£„ÉºÔºÅ</div>
      <div class="ending-line" data-delay="13000" style="font-size:13px; color:#a4b0be; margin-top:20px;">‚Äî „Åä„Åó„Åæ„ÅÑ ‚Äî</div>
      <div class="ending-line" data-delay="14500">
        <div class="btn-start" id="btnRestart" style="font-size:16px; padding:12px 30px; margin-top:10px;">„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „ÅÇ„Åù„Å∂</div>
      </div>
    </div>

    <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº -->
    <div id="gameoverContainer">
      <div id="gameoverTitle">üí§ „Å°„Çá„Å£„Å® „Åä„ÇÑ„Åô„Åø‚Ä¶</div>
      <div id="gameoverMsg">
        „Å§„Åã„Çå„Å°„ÇÉ„Å£„Åü„Å≠„ÄÇ<br>
        „Ç≥„Çπ„É¢„Åü„Å°„Åå „Åä„ÅÜ„Å°„Åæ„Åß<br>
        „Å§„Çå„Å¶„ÅÑ„Å£„Å¶ „Åè„Çå„Çã„Çà„ÄÇ
      </div>
      <div class="btn-start" id="btnRetry">„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑÔºÅ</div>
    </div>
  </div>
</div>

<div id="controls">
  <div class="dpad-container">
    <div class="dpad-cross-v"></div>
    <div class="dpad-cross-h"></div>
    <div class="dpad-center-circle"></div>
    <div class="dpad-touch touch-up" data-key="arrowup"></div>
    <div class="dpad-touch touch-down" data-key="arrowdown"></div>
    <div class="dpad-touch touch-left" data-key="arrowleft"></div>
    <div class="dpad-touch touch-right" data-key="arrowright"></div>
  </div>
  <div class="action-area">
    <div class="btns-bg"></div>
    <div class="ab-btn btn-b" data-action="call">B</div>
    <div class="btn-label" style="bottom: 0px; right: 105px;">B</div>
    <div class="ab-btn btn-a" data-action="throw">A</div>
    <div class="btn-label" style="bottom: 20px; right: 5px;">A</div>
  </div>
</div>

<script>
// ==================== Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É† ====================
const AudioSys = {
  ctx: null,
  init() {
    if (!this.ctx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      this.ctx = new AC();
    }
  },
  resume() {
    if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
  },
  play(type) {
    if (!this.ctx) return;
    const t = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gn = this.ctx.createGain();
    osc.connect(gn); gn.connect(this.ctx.destination);

    if (type === 'throw') {
      osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t+0.1);
      gn.gain.setValueAtTime(0.1, t); gn.gain.linearRampToValueAtTime(0, t+0.15);
      osc.start(t); osc.stop(t+0.15);
    } else if (type === 'hello') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(600, t); osc.frequency.setValueAtTime(900, t+0.1);
      gn.gain.setValueAtTime(0.1, t); gn.gain.linearRampToValueAtTime(0, t+0.2);
      osc.start(t); osc.stop(t+0.2);
    } else if (type === 'hit') {
      osc.type = 'square'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(50, t+0.1);
      gn.gain.setValueAtTime(0.1, t); gn.gain.linearRampToValueAtTime(0, t+0.1);
      osc.start(t); osc.stop(t+0.1);
    } else if (type === 'damage') {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, t); osc.frequency.linearRampToValueAtTime(50, t+0.3);
      gn.gain.setValueAtTime(0.1, t); gn.gain.linearRampToValueAtTime(0, t+0.3);
      osc.start(t); osc.stop(t+0.3);
    } else if (type === 'heal') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t+0.3);
      gn.gain.setValueAtTime(0.1, t); gn.gain.linearRampToValueAtTime(0, t+0.3);
      osc.start(t); osc.stop(t+0.3);
    } else if (type === 'clear') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(523, t);
      osc.frequency.setValueAtTime(659, t+0.15);
      osc.frequency.setValueAtTime(783, t+0.3);
      osc.frequency.setValueAtTime(1046, t+0.45);
      gn.gain.setValueAtTime(0.12, t); gn.gain.linearRampToValueAtTime(0, t+0.9);
      osc.start(t); osc.stop(t+0.9);
    } else if (type === 'prologue') {
      // Èùô„Åã„Å™„Ç≠„É©„Ç≠„É©Èü≥
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, t);
      osc.frequency.linearRampToValueAtTime(1200, t+0.4);
      osc.frequency.linearRampToValueAtTime(600, t+0.8);
      gn.gain.setValueAtTime(0.04, t); gn.gain.linearRampToValueAtTime(0, t+1.0);
      osc.start(t); osc.stop(t+1.0);
    } else if (type === 'stageStart') {
      // „Çπ„ÉÜ„Éº„Ç∏ÈñãÂßã„Ç∏„É≥„Ç∞„É´
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(392, t);      // „ÇΩ
      osc.frequency.setValueAtTime(523, t+0.12);  // „Éâ
      osc.frequency.setValueAtTime(659, t+0.24);  // „Éü
      gn.gain.setValueAtTime(0.1, t); gn.gain.linearRampToValueAtTime(0, t+0.5);
      osc.start(t); osc.stop(t+0.5);
    } else if (type === 'tension') {
      // ‰∏çÁ©è„Å™Èü≥
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(80, t);
      osc.frequency.linearRampToValueAtTime(120, t+0.6);
      osc.frequency.linearRampToValueAtTime(60, t+1.2);
      gn.gain.setValueAtTime(0.05, t); gn.gain.linearRampToValueAtTime(0, t+1.2);
      osc.start(t); osc.stop(t+1.2);
    } else if (type === 'ending') {
      // „ÅÇ„Åü„Åü„Åã„ÅÑ„Ç≥„Éº„Éâ
      const play = (freq, delay, dur) => {
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        o.type = 'sine';
        o.frequency.setValueAtTime(freq, t + delay);
        g.gain.setValueAtTime(0.06, t + delay);
        g.gain.linearRampToValueAtTime(0, t + delay + dur);
        o.start(t + delay); o.stop(t + delay + dur);
      };
      play(523, 0, 1.5);   // „Éâ
      play(659, 0, 1.5);   // „Éü
      play(783, 0, 1.5);   // „ÇΩ
      play(659, 0.5, 1.0); // „Éü
      play(783, 0.5, 1.0); // „ÇΩ
      play(1046, 0.5, 1.5);// „Éâ
      play(523, 1.2, 2.0); // „ÉâÔºà‰ΩéÔºâ
      play(783, 1.2, 2.0); // „ÇΩ
      play(1046, 1.2, 2.0);// „ÉâÔºàÈ´òÔºâ
      return; // Ë§áÊï∞osc‰Ωø„ÅÜ„ÅÆ„Åß„Åì„Åì„Åßreturn
    } else if (type === 'textAppear') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(1000 + Math.random()*400, t);
      gn.gain.setValueAtTime(0.03, t); gn.gain.linearRampToValueAtTime(0, t+0.08);
      osc.start(t); osc.stop(t+0.08);
    }
  }
};

// ==================== „Çπ„Éà„Éº„É™„Éº„Éá„Éº„Çø ====================
const STORY = {
  stages: [
    {
      rank: 1,
      title: '‚Äî „Å°„ÅÑ„Åï„Å™ „Åï„Çè„Åé ‚Äî',
      message: '„ÅÇ„Åù„Åì„Å´ „Éò„É≥„ÉÜ„Ç≥„Åü„Å°„Åå„ÅÑ„Çã„ÄÇ\n„Å™„Çì„Å†„Åã „Åù„Çè„Åù„Çè„Åó„Å¶„Çã„Åø„Åü„ÅÑ‚Ä¶',
      enemies: (lvl) => {
        const arr = [];
        for (let i = 0; i < 4; i++) {
          arr.push({
            x: Math.random() < 0.5 ? -50 : 850,
            y: 100 + Math.random() * 400,
            hp: 45, maxHp: 45, def: 0, atk: 5,
            isBoss: false, name: '„Éò„É≥„ÉÜ„Ç≥',
            attackCooldown: 0, attached: [], wobble: Math.random()*100,
            color: ['#a29bfe','#fd79a8','#63cdda'][Math.floor(Math.random()*3)]
          });
        }
        return arr;
      },
      clearMessage: '„Åä„Å®„Å™„Åó„Åè„Å™„Å£„ÅüÔºÅ\n„Åß„ÇÇ „Åæ„Å† „Åä„Åè„Åã„Çâ „Åä„Åä„Åç„Å™ „Åì„Åà„Åå‚Ä¶'
    },
    {
      rank: 2,
      title: '‚Äî „ÇÇ„Å£„Å® „Åä„Åè„Å∏ ‚Äî',
      message: '„Åì„Åà„Åå „Åä„Åä„Åç„Åè„Å™„Å£„Å¶„Åç„Åü„ÄÇ\n„Éò„É≥„ÉÜ„Ç≥„Åü„Å°„Åå „ÇÇ„Å£„Å® „ÅÇ„Å§„Åæ„Å£„Å¶„ÇãÔºÅ',
      enemies: (lvl) => {
        const arr = [];
        for (let i = 0; i < 6; i++) {
          arr.push({
            x: Math.random() < 0.5 ? -50 : 850,
            y: 100 + Math.random() * 400,
            hp: 55, maxHp: 55, def: 0, atk: 8,
            isBoss: false, name: '„Éò„É≥„ÉÜ„Ç≥',
            attackCooldown: 0, attached: [], wobble: Math.random()*100,
            color: ['#a29bfe','#fd79a8','#63cdda','#ffa502'][Math.floor(Math.random()*4)]
          });
        }
        return arr;
      },
      clearMessage: '„Åø„Çì„Å™ „Åä„Å°„Å§„ÅÑ„ÅüÔºÅ\n‚Ä¶„ÅÇ„ÄÅ„ÅÇ„ÅÆ „Åä„Åä„Åç„ÅÑ„ÅÆ„ÅØ‚Ä¶ÔºÅ'
    },
    {
      rank: 3,
      title: '‚Äî „Éë„Éë„Éò„É≥„ÉÜ„Ç≥ ‚Äî',
      message: '„Åä„Åä„Åç„Å™ „Éò„É≥„ÉÜ„Ç≥„Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ\n„Åô„Åî„Åè „Åä„Åì„Å£„Å¶„Çã‚Ä¶ „Å°„Åå„ÅÜ„ÄÅ„Å™„ÅÑ„Å¶„ÇãÔºü',
      enemies: (lvl) => {
        const arr = [];
        // „Éú„Çπ
        arr.push({
          x: 800, y: 300,
          hp: 300, maxHp: 300, def: 5, atk: 15,
          isBoss: true, name: '„Éë„Éë„Éò„É≥„ÉÜ„Ç≥',
          attackCooldown: 0, attached: [], wobble: Math.random()*100,
          color: '#ff7675'
        });
        // „Åä‰æõ
        for (let i = 0; i < 3; i++) {
          arr.push({
            x: Math.random() < 0.5 ? -50 : 850,
            y: 100 + Math.random() * 400,
            hp: 50, maxHp: 50, def: 2, atk: 10,
            isBoss: false, name: '„Éò„É≥„ÉÜ„Ç≥',
            attackCooldown: 0, attached: [], wobble: Math.random()*100,
            color: ['#fab1a0','#ff7675','#e17055'][Math.floor(Math.random()*3)]
          });
        }
        return arr;
      },
      clearMessage: null // „ÇØ„É™„Ç¢ ‚Üí „Ç®„É≥„Éá„Ç£„É≥„Ç∞„Å∏
    }
  ]
};

// ==================== „Ç≤„Éº„É†Êú¨‰Ωì ====================
const game = {
  state: 'menu',
  player: { x:400, y:300, vx:0, vy:0, hp:100, maxHp:100, rank:1, atk:5, swarm:[], maxSwarm:10, animTime:0 },
  stars:[], enemies:[], items:[], bubbles:[], keys:{}, shake:0, time:0, currentStage:0,
  stageClearPending: false,

  phrases: {
    throw: ["„ÅÑ„Å£„Åë„ÉºÔºÅ","„Å®„ÅâÔºÅ","„Åä„Å≠„Åå„ÅÑÔºÅ"],
    hit: ["„Éù„Ç´„ÉÉ","„Éô„Ç∑„ÉÉ","„Éâ„Ç´„ÉÉ"],
    damage: ["„Ç§„ÉÜ„ÉÉ","„ÅÜ„Çè„Å£","„Å≤„Å©„ÅÑÔºÅ"],
    hello: ["„Éè„Éº„Ç§ÔºÅ","„ÅÇ„Åù„ÅºÔºÅ","„É§„ÉÉ„Éõ„Éº"]
  },

  // ---- ÂàùÊúüÂåñ ----
  init() {
    this.svg = document.getElementById('gameSVG');
    this.world = document.getElementById('gameWorld');
    this.bg = document.getElementById('bgLayer');
    this.ui = document.getElementById('uiLayer');

    // ËÉåÊôØ„ÅÆÊòü
    for(let i=0; i<80; i++) {
      const s = document.createElementNS('http://www.w3.org/2000/svg','circle');
      s.setAttribute('cx', Math.random()*800);
      s.setAttribute('cy', Math.random()*600);
      s.setAttribute('r', Math.random()*1.5+0.3);
      const bright = 0.2 + Math.random()*0.5;
      s.setAttribute('fill', `rgba(255,255,255,${bright})`);
      this.bg.appendChild(s);
    }

    // „Ç§„Éô„É≥„Éà
    window.addEventListener('keydown', (e) => this.keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', (e) => this.keys[e.key.toLowerCase()] = false);
    this.svg.addEventListener('mousedown', (e) => {
      if(this.state === 'playing') this.throwSwarmMouse(e);
    });

    this.setupMobileControls();

    // „Éú„Çø„É≥„Éê„Ç§„É≥„Éâ
    document.getElementById('btnStart').addEventListener('click', () => this.startPrologue());
    document.getElementById('btnStart').addEventListener('touchstart', (e) => { e.preventDefault(); this.startPrologue(); }, {passive:false});
    document.getElementById('prologueSkip').addEventListener('click', () => this.endPrologue());
    document.getElementById('prologueSkip').addEventListener('touchstart', (e) => { e.preventDefault(); this.endPrologue(); }, {passive:false});
    document.getElementById('btnRetry').addEventListener('click', () => this.backToTitle());
    document.getElementById('btnRetry').addEventListener('touchstart', (e) => { e.preventDefault(); this.backToTitle(); }, {passive:false});
    document.getElementById('btnRestart').addEventListener('click', () => this.backToTitle());
    document.getElementById('btnRestart').addEventListener('touchstart', (e) => { e.preventDefault(); this.backToTitle(); }, {passive:false});
  },

  setupMobileControls() {
    const handleTouch = (el, key, isAction) => {
      el.addEventListener('touchstart', (e) => {
        e.preventDefault();
        AudioSys.resume();
        if(isAction) {
          if(key==='throw') this.autoAimThrow();
          if(key==='call') this.keys['shift'] = true;
          el.style.transform = "translateY(4px)";
        } else {
          this.keys[key] = true;
        }
      }, {passive:false});
      el.addEventListener('touchend', (e) => {
        e.preventDefault();
        if(isAction) {
          if(key==='call') this.keys['shift'] = false;
          el.style.transform = "translateY(0px)";
        } else {
          this.keys[key] = false;
        }
      }, {passive:false});
    };
    document.querySelectorAll('.dpad-touch').forEach(btn => handleTouch(btn, btn.dataset.key, false));
    handleTouch(document.querySelector('.btn-a'), 'throw', true);
    handleTouch(document.querySelector('.btn-b'), 'call', true);
  },

  // ---- „Éó„É≠„É≠„Éº„Ç∞ ----
  startPrologue() {
    AudioSys.init();
    AudioSys.resume();

    document.getElementById('titleContainer').style.display = 'none';
    document.getElementById('prologueContainer').style.display = 'flex';

    // „Éó„É≠„É≠„Éº„Ç∞SVG„Å´ÊµÅ„ÇåÊòü„ÇíÊèè„Åè
    this.buildPrologueSVG();

    // Ë°å„ÇíÈ†ÜÁï™„Å´„Éï„Çß„Éº„Éâ„Ç§„É≥
    const lines = document.querySelectorAll('.prologue-line');
    lines.forEach((line, i) => {
      const delay = parseInt(line.dataset.delay) || (i * 1800);
      setTimeout(() => {
        line.classList.add('visible');
        AudioSys.play('textAppear');
        if(i === 0 || i === 3) AudioSys.play('prologue');
      }, delay);
    });

    // „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥Ë°®Á§∫
    setTimeout(() => {
      document.getElementById('prologueSkip').classList.add('visible');
    }, 8000);
  },

  buildPrologueSVG() {
    const svg = document.getElementById('prologueSVG');
    svg.innerHTML = '';
    const ns = 'http://www.w3.org/2000/svg';

    // ÊµÅ„Çå„ÇãÊòü„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    for(let i = 0; i < 12; i++) {
      const g = document.createElementNS(ns, 'g');
      const cx = Math.random() * 400;
      const cy = Math.random() * 300;
      const r = 2 + Math.random() * 3;
      const colors = ['#fab1a0','#ffeaa7','#74b9ff','#55efc4'];
      const c = document.createElementNS(ns, 'circle');
      c.setAttribute('cx', cx);
      c.setAttribute('cy', cy);
      c.setAttribute('r', r);
      c.setAttribute('fill', colors[i%4]);
      c.setAttribute('opacity', '0');

      const animOpacity = document.createElementNS(ns, 'animate');
      animOpacity.setAttribute('attributeName', 'opacity');
      animOpacity.setAttribute('values', '0;0.8;0');
      animOpacity.setAttribute('dur', (3 + Math.random()*4)+'s');
      animOpacity.setAttribute('begin', (Math.random()*5)+'s');
      animOpacity.setAttribute('repeatCount', 'indefinite');
      c.appendChild(animOpacity);

      const animCy = document.createElementNS(ns, 'animate');
      animCy.setAttribute('attributeName', 'cy');
      animCy.setAttribute('from', cy);
      animCy.setAttribute('to', cy + 30 + Math.random()*40);
      animCy.setAttribute('dur', (4 + Math.random()*3)+'s');
      animCy.setAttribute('begin', (Math.random()*3)+'s');
      animCy.setAttribute('repeatCount', 'indefinite');
      c.appendChild(animCy);

      g.appendChild(c);
      svg.appendChild(g);
    }
  },

  endPrologue() {
    document.getElementById('prologueContainer').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    this.startGame();
  },

  // ---- „Ç≤„Éº„É†ÈñãÂßã ----
  startGame() {
    this.state = 'playing';
    this.currentStage = 0;
    this.stageClearPending = false;
    this.player = { x:400, y:300, vx:0, vy:0, hp:100, maxHp:100, rank:1, atk:5, swarm:[], maxSwarm:10, animTime:0 };
    this.enemies = []; this.items = []; this.bubbles = []; this.stars = [];
    this.shake = 0; this.time = 0;

    document.getElementById('stats').style.display = 'flex';
    document.getElementById('swarmCounter').style.display = 'block';
    document.getElementById('stageIndicator').style.display = 'block';

    this.showStageIntro(0);
  },

  // ---- „Çπ„ÉÜ„Éº„Ç∏ÈñìÊºîÂá∫ ----
  showStageIntro(stageIdx) {
    this.state = 'cutscene';
    const stage = STORY.stages[stageIdx];
    this.currentStage = stageIdx;

    const overlay = document.getElementById('stageOverlay');
    const title = document.getElementById('stageTitle');
    const msg = document.getElementById('stageMessage');

    title.textContent = stage.title;
    msg.textContent = stage.message;
    title.classList.remove('visible');
    msg.classList.remove('visible');

    overlay.style.display = 'flex';

    // Èü≥
    setTimeout(() => {
      AudioSys.play(stageIdx === 2 ? 'tension' : 'stageStart');
      title.classList.add('visible');
    }, 300);
    setTimeout(() => msg.classList.add('visible'), 1200);

    // Ëá™Âãï„ÅßÈñâ„Åò„Å¶„Ç≤„Éº„É†ÈñãÂßã
    setTimeout(() => {
      title.classList.remove('visible');
      msg.classList.remove('visible');
      setTimeout(() => {
        overlay.style.display = 'none';
        this.beginStage(stageIdx);
      }, 500);
    }, 3800);
  },

  beginStage(stageIdx) {
    const stage = STORY.stages[stageIdx];
    this.state = 'playing';
    this.stageClearPending = false;
    this.player.rank = stage.rank;

    // „Çπ„ÉÜ„Éº„Ç∏Ë°®Á§∫
    document.getElementById('stageLabel').textContent = `${stage.rank} / 3`;

    // ‰ª≤Èñì„ÅÆÊòü„ÇíÈÖçÁΩÆ
    this.spawnStars(8 + stageIdx * 3);
    // ÊïµÈÖçÁΩÆ
    const newEnemies = stage.enemies(stage.rank);
    this.enemies.push(...newEnemies);

    this.lastTime = Date.now();
    this.loop();
  },

  // ---- „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÊºîÂá∫ ----
  onStageClear() {
    if (this.stageClearPending) return;
    this.stageClearPending = true;

    const stageIdx = this.currentStage;
    const stage = STORY.stages[stageIdx];

    AudioSys.play('clear');

    if (stage.clearMessage) {
      this.addBubble(400, 280, stage.clearMessage.split('\n')[0], '#fff', true);
      setTimeout(() => {
        if(stage.clearMessage.split('\n')[1]) {
          this.addBubble(400, 280, stage.clearMessage.split('\n')[1], '#74b9ff', true);
        }
      }, 1500);
    }

    setTimeout(() => {
      this.state = 'cutscene';
      if (stageIdx < STORY.stages.length - 1) {
        // Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏
        this.showStageIntro(stageIdx + 1);
      } else {
        // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÔºÅ
        this.showEnding();
      }
    }, 3500);
  },

  // ---- „Ç®„É≥„Éá„Ç£„É≥„Ç∞ ----
  showEnding() {
    this.state = 'ending';
    document.getElementById('stats').style.display = 'none';
    document.getElementById('swarmCounter').style.display = 'none';
    document.getElementById('stageIndicator').style.display = 'none';

    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    document.getElementById('titleContainer').style.display = 'none';
    document.getElementById('prologueContainer').style.display = 'none';
    document.getElementById('gameoverContainer').style.display = 'none';
    document.getElementById('endingContainer').style.display = 'flex';

    this.buildEndingSVG();
    AudioSys.play('ending');

    // SVG„Éï„Çß„Éº„Éâ„Ç§„É≥
    setTimeout(() => document.getElementById('endingSVG').classList.add('visible'), 500);

    // „ÉÜ„Ç≠„Çπ„ÉàÈ†ÜÊ¨°Ë°®Á§∫
    document.querySelectorAll('#endingContainer .ending-line').forEach(line => {
      const delay = parseInt(line.dataset.delay) || 1000;
      setTimeout(() => {
        line.classList.add('visible');
        if(!line.querySelector('.btn-start')) AudioSys.play('textAppear');
      }, delay);
    });
  },

  buildEndingSVG() {
    const svg = document.getElementById('endingSVG');
    svg.innerHTML = '';
    const ns = 'http://www.w3.org/2000/svg';
    const c = (tag, attrs) => {
      const el = document.createElementNS(ns, tag);
      for(let k in attrs) el.setAttribute(k, attrs[k]);
      return el;
    };

    // ËÉåÊôØ„ÅÆÊòü
    for(let i=0; i<20; i++) {
      const star = c('circle', { cx: Math.random()*300, cy: Math.random()*200, r: Math.random()+0.5, fill: `rgba(255,255,255,${0.3+Math.random()*0.5})` });
      svg.appendChild(star);
    }

    // Âú∞Èù¢ÔºàÊÉëÊòü„ÅÆË°®Èù¢Ôºâ
    svg.appendChild(c('ellipse', { cx:150, cy:185, rx:140, ry:25, fill:'#636e72', opacity:'0.3' }));

    // „Éë„Éë„Éò„É≥„ÉÜ„Ç≥Ôºà„Å´„Åì„Å´„ÅìÔºâ
    const papa = c('g', { transform:'translate(150,120)' });
    papa.appendChild(c('path', { d:'M-40,0 Q-40,-50 0,-50 Q40,-50 40,0 Q40,40 0,40 Q-40,40 -40,0', fill:'#ff7675', stroke:'#fff', 'stroke-width':'2' }));
    papa.appendChild(c('circle', { cx:-12, cy:-10, r:5, fill:'#fff' }));
    papa.appendChild(c('circle', { cx:12, cy:-10, r:5, fill:'#fff' }));
    papa.appendChild(c('circle', { cx:-12, cy:-10, r:2, fill:'#000' }));
    papa.appendChild(c('circle', { cx:12, cy:-10, r:2, fill:'#000' }));
    // „Å´„Å£„Åì„ÇäÂè£
    papa.appendChild(c('path', { d:'M-15,8 Q0,22 15,8', fill:'none', stroke:'#fff', 'stroke-width':'3', 'stroke-linecap':'round' }));

    // „Éë„Éë„ÅÆ‰∏ä„Å´„Ç≥„Çπ„É¢„Åü„Å°
    const colors = ['#fab1a0','#ffeaa7','#74b9ff','#55efc4','#fd79a8'];
    for(let i=0; i<5; i++) {
      const angle = (i/5) * Math.PI*2 - Math.PI/2;
      const sx = Math.cos(angle)*35;
      const sy = Math.sin(angle)*35 - 15;
      const miniStar = c('g', { transform:`translate(${sx},${sy})` });
      const r2 = 6;
      let pts = '';
      for(let j=0; j<5; j++) {
        const th = Math.PI*2*j/5 - Math.PI/2;
        pts += `${Math.cos(th)*r2},${Math.sin(th)*r2} ${Math.cos(th+0.6)*r2*0.5},${Math.sin(th+0.6)*r2*0.5} `;
      }
      miniStar.appendChild(c('polygon', { points:pts, fill:colors[i], stroke:'#fff', 'stroke-width':'1' }));

      // „ÇÜ„Çâ„ÇÜ„Çâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      const anim = document.createElementNS(ns, 'animateTransform');
      anim.setAttribute('attributeName','transform');
      anim.setAttribute('type','translate');
      anim.setAttribute('values', `${sx},${sy};${sx},${sy-4};${sx},${sy}`);
      anim.setAttribute('dur', (1.5+Math.random())+'s');
      anim.setAttribute('repeatCount','indefinite');
      miniStar.appendChild(anim);

      papa.appendChild(miniStar);
    }
    svg.appendChild(papa);

    // „Éó„É¨„Ç§„É§„ÉºÔºàÂ∑¶„Å´Ôºâ
    const pl = c('g', { transform:'translate(60,140)' });
    pl.appendChild(c('rect', { x:-7, y:-14, width:14, height:14, rx:3, fill:'#fff' }));
    pl.appendChild(c('line', { x1:-7, y1:-10, x2:7, y2:-10, stroke:'#e17055', 'stroke-width':2 }));
    pl.appendChild(c('line', { x1:-7, y1:-5, x2:7, y2:-5, stroke:'#e17055', 'stroke-width':2 }));
    pl.appendChild(c('circle', { cx:0, cy:-20, r:8, fill:'#ffeaa7' }));
    pl.appendChild(c('circle', { cx:-2.5, cy:-20, r:1, fill:'#000' }));
    pl.appendChild(c('circle', { cx:2.5, cy:-20, r:1, fill:'#000' }));
    pl.appendChild(c('path', { d:'M-8,-23 Q0,-32 8,-23 L8,-20 L-8,-20 Z', fill:'#d63031' }));
    // Êâã„Çí‰∏ä„Åí„Çã„Éù„Éº„Ç∫
    pl.appendChild(c('line', { x1:7, y1:-10, x2:14, y2:-20, stroke:'#ffeaa7', 'stroke-width':2, 'stroke-linecap':'round' }));
    svg.appendChild(pl);

    // „Éî„Ç∂ÔºàÂè≥„Å´Ôºâ
    const pizza = c('g', { transform:'translate(240,145)' });
    pizza.appendChild(c('path', { d:'M0,-15 L12,10 L-12,10 Z', fill:'#f1c40f', stroke:'#e67e22', 'stroke-width':'1.5' }));
    pizza.appendChild(c('circle', { cx:-2, cy:0, r:2, fill:'#e74c3c' }));
    pizza.appendChild(c('circle', { cx:4, cy:3, r:2, fill:'#e74c3c' }));
    pizza.appendChild(c('circle', { cx:1, cy:-5, r:1.5, fill:'#27ae60' }));

    const pizzaAnim = document.createElementNS(ns, 'animateTransform');
    pizzaAnim.setAttribute('attributeName','transform');
    pizzaAnim.setAttribute('type','translate');
    pizzaAnim.setAttribute('values','240,145;240,141;240,145');
    pizzaAnim.setAttribute('dur','2s');
    pizzaAnim.setAttribute('repeatCount','indefinite');
    pizza.appendChild(pizzaAnim);
    svg.appendChild(pizza);
  },

  // ---- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº ----
  showGameOver() {
    this.state = 'gameover';
    document.getElementById('stats').style.display = 'none';
    document.getElementById('swarmCounter').style.display = 'none';
    document.getElementById('stageIndicator').style.display = 'none';

    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    document.getElementById('titleContainer').style.display = 'none';
    document.getElementById('prologueContainer').style.display = 'none';
    document.getElementById('endingContainer').style.display = 'none';
    document.getElementById('gameoverContainer').style.display = 'flex';
  },

  // ---- „Çø„Ç§„Éà„É´„Å´Êàª„Çã ----
  backToTitle() {
    // „É™„Çª„ÉÉ„Éà
    this.state = 'menu';
    this.world.innerHTML = '';
    this.ui.innerHTML = '';

    document.getElementById('stats').style.display = 'none';
    document.getElementById('swarmCounter').style.display = 'none';
    document.getElementById('stageIndicator').style.display = 'none';
    document.getElementById('stageOverlay').style.display = 'none';

    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    overlay.classList.remove('hidden');
    document.getElementById('titleContainer').style.display = 'flex';
    document.getElementById('prologueContainer').style.display = 'none';
    document.getElementById('endingContainer').style.display = 'none';
    document.getElementById('gameoverContainer').style.display = 'none';

    // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÅÆvisible„ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
    document.querySelectorAll('.ending-line').forEach(l => l.classList.remove('visible'));
    document.querySelectorAll('.prologue-line').forEach(l => l.classList.remove('visible'));
    document.getElementById('endingSVG').classList.remove('visible');
    document.getElementById('prologueSkip').classList.remove('visible');
  },

  // ---- „Ç≤„Éº„É†„É´„Éº„Éó ----
  loop() {
    if (this.state !== 'playing') return;
    const now = Date.now();
    const dt = Math.min((now - this.lastTime) / 1000, 0.05); // cap
    this.lastTime = now;
    this.time += dt;
    this.update(dt);
    this.render();
    requestAnimationFrame(() => this.loop());
  },

  update(dt) {
    const speed = 200;
    this.player.vx = 0; this.player.vy = 0;
    let moving = false;
    if (this.keys['w']||this.keys['arrowup']) { this.player.vy=-speed; moving=true; }
    if (this.keys['s']||this.keys['arrowdown']) { this.player.vy=speed; moving=true; }
    if (this.keys['a']||this.keys['arrowleft']) { this.player.vx=-speed; moving=true; }
    if (this.keys['d']||this.keys['arrowright']) { this.player.vx=speed; moving=true; }
    if(moving) this.player.animTime += dt*12;
    this.player.x = Math.max(40, Math.min(760, this.player.x+this.player.vx*dt));
    this.player.y = Math.max(40, Math.min(560, this.player.y+this.player.vy*dt));

    // Âëº„Å≥Êàª„Åó
    if (this.keys['shift']) {
      this.player.swarm.forEach(u => { if(u.state!=='follow'){u.state='follow';u.target=null;} });
    }

    // ÊòüÂõûÂèé
    for (let i=this.stars.length-1;i>=0;i--) {
      const s=this.stars[i];
      if(Math.hypot(this.player.x-s.x,this.player.y-s.y)<45 && this.player.swarm.length<this.player.maxSwarm) {
        this.player.swarm.push({
          x:s.x,y:s.y,z:0,state:'follow',target:null,
          angle:Math.random()*Math.PI*2,color:s.color,scale:s.scale
        });
        this.stars.splice(i,1);
        AudioSys.play('hello');
        this.addBubble(s.x,s.y-30,this.phrases.hello[Math.floor(Math.random()*3)],s.color);
      }
    }

    // „Ç¢„Ç§„ÉÜ„É†
    for(let i=this.items.length-1;i>=0;i--) {
      const item=this.items[i];
      if(Math.hypot(this.player.x-item.x,this.player.y-item.y)<40) {
        this.player.hp=Math.min(this.player.maxHp,this.player.hp+30);
        AudioSys.play('heal');
        this.addBubble(this.player.x,this.player.y-40,"„Åí„Çì„Åç „Åß„ÅüÔºÅ",'#fff');
        this.items.splice(i,1);
      }
    }

    // ‰ª≤Èñì„É≠„Ç∏„ÉÉ„ÇØ
    this.player.swarm.forEach((unit,idx) => {
      if(unit.state==='follow') {
        unit.angle += dt*1.5;
        const r=35+Math.sin(this.time+idx)*5+Math.floor(idx/5)*12;
        unit.x += (this.player.x+Math.cos(unit.angle+idx)*r - unit.x)*5*dt;
        unit.y += (this.player.y+Math.sin(unit.angle+idx)*r - unit.y)*5*dt;
        unit.z = Math.abs(Math.sin(this.time*4+idx))*8;
      } else if(unit.state==='thrown') {
        unit.x += unit.vx*dt; unit.y += unit.vy*dt; unit.z += unit.vz*dt;
        unit.vz -= 500*dt;
        if(unit.z<=0){unit.z=0;unit.state='follow';}
        this.enemies.forEach(e => {
          if(Math.hypot(unit.x-e.x,unit.y-e.y)<(e.isBoss?60:35) && unit.z<40) {
            unit.state='attached'; unit.target=e; e.attached.push(unit);
            AudioSys.play('hit');
            if(Math.random()<0.3) this.addBubble(e.x+(Math.random()-0.5)*30,e.y-40,this.phrases.hit[Math.floor(Math.random()*3)],'#ffeaa7');
          }
        });
      } else if(unit.state==='attached') {
        if(unit.target&&unit.target.hp>0) {
          const t=unit.target;
          const off=this.time*10+idx;
          unit.x=t.x+Math.cos(off)*(t.isBoss?40:20);
          unit.y=t.y+Math.sin(off)*(t.isBoss?40:20);
          unit.z=10;
        } else {
          unit.state='follow'; unit.target=null;
        }
      }
    });

    // Êïµ„É≠„Ç∏„ÉÉ„ÇØ
    this.enemies.forEach(e => {
      e.wobble += dt;
      const dist=Math.hypot(this.player.x-e.x,this.player.y-e.y);
      if(dist<600) {
        const spd=e.isBoss?35:55;
        const ang=Math.atan2(this.player.y-e.y,this.player.x-e.x);
        e.x+=Math.cos(ang)*spd*dt;
        e.y+=Math.sin(ang)*spd*dt;
        if(dist<(e.isBoss?60:40)) {
          e.attackCooldown-=dt;
          if(e.attackCooldown<=0) {
            this.player.hp-=e.atk; e.attackCooldown=1.5;
            this.shake=15; AudioSys.play('damage');
            this.addBubble(this.player.x,this.player.y-40,this.phrases.damage[Math.floor(Math.random()*3)],'#ff4757');
            if(this.player.hp<=0) { this.player.hp=0; this.showGameOver(); return; }
          }
        }
      }
      // „Åè„Å£„Å§„ÅÑ„Å¶„Çã‰ª≤Èñì„Åã„Çâ„ÉÄ„É°„Éº„Ç∏
      if(e.attached.length>0) {
        let dmg=(this.player.atk*e.attached.length)-e.def;
        const isSmash = Math.random()<0.03;
        if(isSmash) { dmg*=2; this.shake=10; this.addBubble(e.x,e.y-50,"SMAAAASH!!",'#f1c40f',true); }
        e.hp -= Math.max(1,dmg)*dt;
        if(e.hp<=0) this.killEnemy(e);
      }
    });

    // „Éï„Ç≠„ÉÄ„Ç∑Êõ¥Êñ∞
    for(let i=this.bubbles.length-1;i>=0;i--) {
      const b=this.bubbles[i];
      b.life-=dt; b.x+=b.vx*dt; b.y+=b.vy*dt;
      if(b.life<=0) this.bubbles.splice(i,1);
    }
    if(this.shake>0) this.shake*=0.9;

    // „ÇØ„É™„Ç¢Âà§ÂÆö
    if(this.enemies.length===0 && !this.stageClearPending) {
      this.onStageClear();
    }

    this.updateUI();
  },

  updateUI() {
    document.getElementById('hpText').textContent = Math.max(0,Math.floor(this.player.hp));
    document.getElementById('rankText').textContent = this.player.rank;
    document.getElementById('swarmText').textContent = this.player.swarm.length;
  },

  spawnStars(count) {
    for(let i=0;i<count;i++) {
      this.stars.push({
        x:50+Math.random()*700, y:50+Math.random()*500,
        color:['#fab1a0','#ffeaa7','#74b9ff','#55efc4'][Math.floor(Math.random()*4)],
        scale:0.8+Math.random()*0.4
      });
    }
  },

  killEnemy(e) {
    if(Math.random()<0.4) this.items.push({x:e.x,y:e.y});
    this.player.atk+=1; this.player.maxSwarm+=1;
    e.attached.forEach(u=>{u.state='follow';u.target=null;});
    const idx=this.enemies.indexOf(e);
    if(idx>-1) this.enemies.splice(idx,1);
    this.shake=20;
    if(e.isBoss) {
      this.addBubble(e.x,e.y-20,"‚Ä¶„Åî„ÇÅ„Çì„Å≠",'#fab1a0',true);
    } else {
      const msgs = ["„Åä„Å®„Å™„Åó„Åè„Å™„Å£„ÅüÔºÅ","„Åç„ÇÇ„Å°„Åå „Åä„Å°„Å§„ÅÑ„ÅüÔºÅ","„Åµ„ÅÜ„ÄÅ„Åô„Å£„Åç„ÇäÔºÅ"];
      this.addBubble(e.x,e.y,msgs[Math.floor(Math.random()*msgs.length)],'#fff',true);
    }
  },

  addBubble(x,y,text,color,isBig=false) {
    const mx=Math.max(100,Math.min(700,x));
    const my=Math.max(50,Math.min(550,y));
    this.bubbles.push({
      x:mx,y:my,text,color,isBig,life:2.0,
      vx:(Math.random()-0.5)*30, vy:-25-Math.random()*15
    });
  },

  autoAimThrow() {
    if(this.state!=='playing'||this.player.swarm.length===0) return;
    let target=null,minDist=9999;
    this.enemies.forEach(e=>{
      const d=Math.hypot(e.x-this.player.x,e.y-this.player.y);
      if(d<minDist){minDist=d;target=e;}
    });
    let tx=target?target.x:this.player.x+100;
    let ty=target?target.y:this.player.y;
    this.execThrow(tx,ty);
  },

  throwSwarmMouse(e) {
    const rect=this.svg.getBoundingClientRect();
    const tx=(e.clientX-rect.left)*(800/rect.width);
    const ty=(e.clientY-rect.top)*(600/rect.height);
    this.execThrow(tx,ty);
  },

  execThrow(tx,ty) {
    const unit=this.player.swarm.find(u=>u.state==='follow');
    if(unit) {
      const dist=Math.hypot(tx-unit.x,ty-unit.y)||1;
      unit.vx=((tx-unit.x)/dist)*550;
      unit.vy=((ty-unit.y)/dist)*550;
      unit.vz=350;
      unit.state='thrown';
      AudioSys.play('throw');
      if(Math.random()<0.3) this.addBubble(this.player.x,this.player.y-50,this.phrases.throw[Math.floor(Math.random()*3)],'#fff');
    }
  },

  // ---- ÊèèÁîª ----
  render() {
    this.world.innerHTML=''; this.ui.innerHTML='';
    const sx=(Math.random()-0.5)*this.shake;
    const sy=(Math.random()-0.5)*this.shake;
    const c=(tag,attrs)=>{
      const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
      for(let k in attrs) el.setAttribute(k,attrs[k]);
      return el;
    };

    // „Ç¢„Ç§„ÉÜ„É†Ôºà„Éè„Éº„Éà„ÅÆÂõûÂæ©„Ç¢„Ç§„ÉÜ„É†Ôºâ
    this.items.forEach(it=>{
      const g=c('g',{transform:`translate(${it.x+sx},${it.y+sy})`});
      const bob = Math.sin(this.time*3)*3;
      g.setAttribute('transform', `translate(${it.x+sx},${it.y+sy+bob})`);
      g.appendChild(c('path',{d:'M0,-6 C-8,-14 -16,-4 0,8 C16,-4 8,-14 0,-6',fill:'#ff6b81',stroke:'#fff','stroke-width':1.5}));
      this.world.appendChild(g);
    });

    // ÊòüÔºàÈõÜ„ÇÅ„Çã‰ª≤ÈñìÔºâ
    this.stars.forEach(s=>{
      const bob=Math.sin(this.time*2+s.x)*4;
      const g=c('g',{transform:`translate(${s.x+sx},${s.y+sy+bob})`});
      const r=10*s.scale;
      let pts='';
      for(let i=0;i<5;i++){
        const th=Math.PI*2*i/5-Math.PI/2;
        pts+=`${Math.cos(th)*r},${Math.sin(th)*r} ${Math.cos(th+0.6)*r*0.5},${Math.sin(th+0.6)*r*0.5} `;
      }
      g.appendChild(c('polygon',{points:pts,fill:s.color,stroke:'#fff','stroke-width':1,opacity:'0.8'}));
      // „Ç≠„É©„Ç≠„É©
      const sparkle = Math.sin(this.time*5+s.y)*0.3+0.7;
      g.appendChild(c('circle',{cx:0,cy:0,r:2,fill:'#fff',opacity:sparkle}));
      this.world.appendChild(g);
    });

    // Êïµ
    this.enemies.forEach(e=>{
      const warp=Math.sin(this.time*8+e.wobble)*3;
      const g=c('g',{transform:`translate(${e.x+sx},${e.y+sy})`});
      const size=e.isBoss?60:30;
      g.appendChild(c('ellipse',{cx:0,cy:size/2+10,rx:size,ry:size/3,fill:'rgba(0,0,0,0.3)'}));
      g.appendChild(c('path',{d:`M-${size},0 Q-${size},-${size+warp} 0,-${size+warp} Q${size},-${size+warp} ${size},0 Q${size},${size-warp} 0,${size-warp} Q-${size},${size-warp} -${size},0`,fill:e.color,stroke:'#fff','stroke-width':3}));
      const eyey=-size/4;
      g.appendChild(c('circle',{cx:-size/3,cy:eyey,r:size/6,fill:'#fff'}));
      g.appendChild(c('circle',{cx:size/3,cy:eyey,r:size/6,fill:'#fff'}));

      // ÊÄí„ÇäÂÖ∑Âêà„ÅßÁõÆ„ÅÆË°®ÊÉÖ„ÇíÂ§â„Åà„Çã
      const hpRatio = e.hp / e.maxHp;
      if(hpRatio > 0.5) {
        // ÊÄí„ÇäÈ°î
        g.appendChild(c('circle',{cx:-size/3,cy:eyey,r:size/15,fill:'#000'}));
        g.appendChild(c('circle',{cx:size/3,cy:eyey,r:size/15,fill:'#000'}));
        // ÊÄí„ÇäÁúâ
        g.appendChild(c('line',{x1:-size/2,y1:eyey-size/5,x2:-size/6,y2:eyey-size/8,stroke:'#000','stroke-width':2,'stroke-linecap':'round'}));
        g.appendChild(c('line',{x1:size/2,y1:eyey-size/5,x2:size/6,y2:eyey-size/8,stroke:'#000','stroke-width':2,'stroke-linecap':'round'}));
      } else {
        // „Åä„Å°„Å§„ÅçÂßã„ÇÅÔºàÁõÆ„Åå„ÅÜ„Çã„ÅÜ„ÇãÔºâ
        g.appendChild(c('circle',{cx:-size/3,cy:eyey+2,r:size/12,fill:'#000'}));
        g.appendChild(c('circle',{cx:size/3,cy:eyey+2,r:size/12,fill:'#000'}));
        g.appendChild(c('circle',{cx:-size/3+1,cy:eyey,r:size/25,fill:'#fff'}));
        g.appendChild(c('circle',{cx:size/3+1,cy:eyey,r:size/25,fill:'#fff'}));
      }

      // Âè£
      if(hpRatio > 0.5) {
        if(e.isBoss) g.appendChild(c('path',{d:`M-${size/3},8 Q0,-4 ${size/3},8`,fill:'none',stroke:'#000','stroke-width':3}));
        else g.appendChild(c('path',{d:`M-${size/4},5 L${size/4},5`,stroke:'#000','stroke-width':2}));
      } else {
        // „Åä„Å†„ÇÑ„Åã„Å™Âè£
        if(e.isBoss) g.appendChild(c('path',{d:`M-${size/3},5 Q0,18 ${size/3},5`,fill:'none',stroke:'#fff','stroke-width':3}));
        else g.appendChild(c('circle',{cx:0,cy:8,r:3,fill:'#000',opacity:'0.4'}));
      }

      // HP„Éê„ÉºÔºà„Åî„Åç„Åí„Çì„Ç≤„Éº„Ç∏Ôºâ
      if(e.hp<e.maxHp) {
        const bw=60;
        g.appendChild(c('rect',{x:-bw/2,y:-size-22,width:bw,height:8,fill:'#444',rx:4}));
        // ÊÄí„Çä‚Üí„Åä„Å†„ÇÑ„ÅãÔºàËµ§‚ÜíÁ∑ëÔºâ
        const ratio = e.hp/e.maxHp;
        const barColor = ratio>0.5 ? '#e74c3c' : '#2ed573';
        g.appendChild(c('rect',{x:-bw/2+2,y:-size-20,width:(bw-4)*ratio,height:4,fill:barColor,rx:2}));
        // „É©„Éô„É´
        const label = c('text',{x:0,y:-size-26,'font-size':'8','text-anchor':'middle',fill:'#dfe6e9'});
        label.textContent = ratio>0.5 ? '„Å∑„Çì„Å∑„Çì' : '„Åä„Å°„Å§„Åç‰∏≠‚Ä¶';
        g.appendChild(label);
      }

      this.world.appendChild(g);
    });

    // ‰ª≤Èñì
    this.player.swarm.forEach(u=>{
      const jump=-u.z;
      const g=c('g',{transform:`translate(${u.x+sx},${u.y+jump+sy}) scale(${u.scale||1})`});
      const r=10;
      let points='';
      for(let i=0;i<5;i++){
        const th=Math.PI*2*i/5-Math.PI/2;
        points+=`${Math.cos(th)*r},${Math.sin(th)*r} ${Math.cos(th+0.6)*r*0.5},${Math.sin(th+0.6)*r*0.5} `;
      }
      g.appendChild(c('polygon',{points,fill:u.color,stroke:'#fff','stroke-width':1.5}));
      g.appendChild(c('circle',{cx:-3,cy:-1,r:1.5,fill:'#000'}));
      g.appendChild(c('circle',{cx:3,cy:-1,r:1.5,fill:'#000'}));
      // „Åè„Å£„Å§„ÅÑ„Å¶„Çã„Å®„Åç„ÅØ„Éè„Éº„Éà
      if(u.state==='attached') {
        g.appendChild(c('path',{d:'M0,-8 C-3,-11 -6,-8 0,-4 C6,-8 3,-11 0,-8',fill:'#ff6b81','stroke-width':0,opacity:'0.7',transform:'translate(0,-14) scale(0.6)'}));
      }
      this.world.appendChild(g);
    });

    // „Éó„É¨„Ç§„É§„Éº
    const pg=c('g',{transform:`translate(${this.player.x+sx},${this.player.y+sy})`});
    const bob=Math.abs(Math.sin(this.player.animTime))*4;
    const tilt=this.player.vx*0.04;
    pg.appendChild(c('ellipse',{cx:0,cy:5,rx:12,ry:4,fill:'rgba(0,0,0,0.3)'}));
    const bodyG=c('g',{transform:`translate(0,${-bob}) rotate(${tilt})`});
    bodyG.appendChild(c('rect',{x:-9,y:-18,width:18,height:18,rx:4,fill:'#fff'}));
    bodyG.appendChild(c('line',{x1:-9,y1:-14,x2:9,y2:-14,stroke:'#e17055','stroke-width':3}));
    bodyG.appendChild(c('line',{x1:-9,y1:-8,x2:9,y2:-8,stroke:'#e17055','stroke-width':3}));
    bodyG.appendChild(c('circle',{cx:0,cy:-24,r:11,fill:'#ffeaa7'}));
    bodyG.appendChild(c('circle',{cx:-3.5,cy:-24,r:1.5,fill:'#000'}));
    bodyG.appendChild(c('circle',{cx:-4.5,cy:-25,r:0.5,fill:'#fff'}));
    bodyG.appendChild(c('circle',{cx:3.5,cy:-24,r:1.5,fill:'#000'}));
    bodyG.appendChild(c('circle',{cx:2.5,cy:-25,r:0.5,fill:'#fff'}));
    bodyG.appendChild(c('path',{d:'M-11,-28 Q0,-40 11,-28 L11,-24 L-11,-24 Z',fill:'#d63031'}));
    bodyG.appendChild(c('rect',{x:8,y:-28,width:6,height:4,fill:'#d63031'}));
    pg.appendChild(bodyG);
    this.world.appendChild(pg);

    // „Éï„Ç≠„ÉÄ„Ç∑
    this.bubbles.forEach(b=>{
      const alpha = Math.min(1, b.life / 0.5);
      const g=c('g',{transform:`translate(${b.x+sx},${b.y+sy})`,opacity:alpha});
      const fs=b.isBig?22:13;
      const pad=b.isBig?18:10;
      const w=b.text.length*fs+pad*2;
      const h=b.isBig?36:24;
      const boxTop=-h/2-4;
      if(b.isBig) {
        const path=`M${-w/2},${boxTop} L${w/2},${boxTop} L${w/2+8},${boxTop+h/2} L${w/2},${boxTop+h} L${-w/2},${boxTop+h} L${-w/2-8},${boxTop+h/2} Z`;
        g.appendChild(c('path',{d:path,fill:b.color,stroke:'#333','stroke-width':2}));
      } else {
        g.appendChild(c('rect',{x:-w/2,y:boxTop,width:w,height:h,rx:10,fill:b.color,stroke:'#555','stroke-width':1}));
        g.appendChild(c('path',{d:`M-4,${boxTop+h} L0,${boxTop+h+5} L4,${boxTop+h}`,fill:b.color}));
      }
      const t=c('text',{x:0,y:boxTop+h/2,'font-size':fs,'text-anchor':'middle','dominant-baseline':'central',fill:'#333','font-weight':'bold'});
      t.textContent=b.text;
      g.appendChild(t);
      this.ui.appendChild(g);
    });
  }
};

window.addEventListener('load', () => game.init());
</script>
</body>
</html>
